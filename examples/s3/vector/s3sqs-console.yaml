sources:
  s3_logs_source:
    type: "aws_s3"
    region: "us-east-1" 
    sqs:
      queue_url: "$VECTOR_SQS"
    compression: "auto"
  internal_metrics:
    type: "internal_metrics"

transforms:
  explode_audit_events:
    type: "remap"
    inputs: ["s3_logs_source"]
    source: |
      # Parse the stringified JSON into an actual array
      .message = parse_json!(.message)
      . = unnest!(.message)
  flatten_structure:
    type: "remap"
    inputs: ["explode_audit_events"]
    source: |
      .orig_message = encode_json!(.message)
      . = merge!(., .message)
      del(.message)
sinks:
  # Sink to write events to rotating JSON files on disk
  file_output:
    type: "file"
    inputs: ["flatten_structure"]
    path: "./tmp/json_event/vector-%Y-%m-%dT%H.json"
    encoding:
      codec: "json"
  prometheus:
    type: "prometheus_exporter"
    inputs:
      - internal_metrics
    address: "0.0.0.0:9090"
    
api:
  enabled: true
  address: "0.0.0.0:8686"
